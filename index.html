<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PapuDomo - Sistema de Teleoperación de un Telescopio</title>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="PapuDomo.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <video class="video-background" autoplay muted loop playsinline>
        <source src="ASTRO2.mp4" type="video/mp4">
        Tu navegador no soporta video.
    </video>
    <div class="overlay"></div>

    <nav class="navbar glass">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li class="submenu">
                <a href="#">Acerca del Proyecto</a>
                <ul class="dropdown">
                    <li><a href="codigo.html">Códigos</a></li>
                    <li><a href="procedimiento.html">Procedimiento</a></li>
                    <li><a href="materiales.html">Materiales</a></li>
                </ul>
            </li>
            <li><a href="control.html">Control del domo</a></li>


            <li style="margin-left:auto; color:#cccccc; font-size:0.95rem;">
                Usuario: <span id="nombreUsuario" style="color:#ffffff; font-weight:600;">---</span>
            </li>

            <li style="margin-left:10px;">
                <a href="javascript:logout()" style="color:#ffffff; font-weight:bold;">Cerrar sesión</a>
            </li>
        </ul>
    </nav>

    <header class="titulo-container">
        <h1 class="titulo">SISTEMA DE TELEOPERACIÓN DE UN TELESCOPIO</h1>
       
    </header>

    <div class="container">
        <section class="card glass">
            <h2>Telescopios disponibles</h2>
            <div id="listaTelescopios"></div>
        </section>

        <section class="card glass">
            <h2>Mis sesiones</h2>
            <div id="misSesiones"></div>
        </section>
    </div>

    <footer class="glass">
        © 2025 - Proyecto Domo Telescopio Automatizado con ESP32
    </footer>

    <script type="module" src="api.js"></script>
    <script type="module" src="dashboard.js"></script>

   <!-- =========================
     LOGOUT COMPLETO PAPUDOMO
     (borra de queue + finaliza sesion + signOut)
========================= -->
<script type="module">
  import {
    supabase,
    obtenerUsuario,
    borrarDeColaUsuario,
    finalizarSesionUsuario
  } from "./api.js";

  // Logout global para el navbar
  window.logout = async function () {
    try {
      // 1) Email guardado local
      const local = localStorage.getItem("papudomo_user");
      const email = local ? JSON.parse(local).email : null;

      if (!email) {
        localStorage.removeItem("papudomo_user");
        window.location.href = "registro.html";
        return;
      }

      // 2) Obtener perfil real desde tabla usuario
      const { data: perfil, error: pErr } = await obtenerUsuario(email);

      if (pErr || !perfil) {
        console.error("PERFIL ERROR:", pErr);

        // Igual cerrar auth y salir
        await supabase.auth.signOut();
        localStorage.removeItem("papudomo_user");
        window.location.href = "registro.html";
        return;
      }

      const id_usuario = perfil.id_usuario;

      // 3) Borrar de la cola FIFO si estaba esperando
      await borrarDeColaUsuario(id_usuario);

      // 4) Finalizar cualquier sesión activa del usuario
      await finalizarSesionUsuario(id_usuario);

      // 5) Cerrar sesión Auth + limpiar localStorage
      await supabase.auth.signOut();
      localStorage.removeItem("papudomo_user");

      // 6) Redirigir login
      window.location.href = "registro.html";

    } catch (e) {
      console.error("LOGOUT ERROR:", e);
      localStorage.removeItem("papudomo_user");
      window.location.href = "registro.html";
    }
  };
</script>
<!-- =========================
     MODAL TURNO ASIGNADO (FIFO)
========================= -->
<div id="turnoModal" class="turno-modal hidden">
  <div class="turno-box glass">
    <h2>Es tu turno</h2>
    <p>
      Ahora tienes acceso al telescopio.<br>
      Tienes <b id="turnoTiempo">10 minutos</b> para usar el domo.
    </p>
    <button id="btnTurnoOk" class="turno-btn">Entendido</button>
  </div>
</div>

</body>
</html>
